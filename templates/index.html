<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTSP to HLS Stream with YOLOv11</title>
    <link href="https://vjs.zencdn.net/7.4.1/video-js.css" rel="stylesheet">
    <script src='https://vjs.zencdn.net/7.4.1/video.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-contrib-hls/5.15.0/videojs-contrib-hls.min.js" type="text/javascript"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #video_feed {
            max-width: 100%;
            border: 1px solid #ccc;
        }
        .controls {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>RTSP to HLS Stream with YOLOv11</h1>
        <div class="controls">
            <label for="rtsp_url">RTSP URL:</label>
            <input type="text" id="rtsp_url" placeholder="Enter RTSP URL" value="http://ottrrs.hl.chinamobile.com/PLTV/88888888/224/3221226016/index.m3u8">
            <button onclick="startStream()">Start Stream</button>
            <button onclick="stopStream()">Stop Stream</button>
            <br><br>
            <label for="conf">Confidence:</label>
            <input type="range" id="conf" min="0" max="1" step="0.01" value="0.5">
            <span id="conf_value">0.5</span>
            <br>
            <label for="iou">IOU:</label>
            <input type="range" id="iou" min="0" max="1" step="0.01" value="0.45">
            <span id="iou_value">0.45</span>
            <br>
            <label for="line_width">Line Width:</label>
            <input type="range" id="line_width" min="1" max="10" step="1" value="2">
            <span id="line_width_value">2</span>
            <br><br>
            <button onclick="updateParams()">Update Parameters</button>
            <div>
                <label for="model_select">Model:</label>
                <select id="model_select"></select>
                <button onclick="changeModel()">Change Model</button>
            </div>
        </div>
        <video id="myVideo" class="video-js vjs-default-skin vjs-big-play-centered" controls preload="auto" data-setup='{}' style='width: 800px;height: 600px'>
            <source id="source" src="/hls/stream.m3u8" type="application/x-mpegURL"></source>
        </video>
    </div>

    <script>
        // 更新参数值显示
        document.getElementById('conf').oninput = function() {
            document.getElementById('conf_value').innerText = this.value;
        };
        document.getElementById('iou').oninput = function() {
            document.getElementById('iou_value').innerText = this.value;
        };
        document.getElementById('line_width').oninput = function() {
            document.getElementById('line_width_value').innerText = this.value;
        };

        // 发送参数更新请求
        function updateParams() {
            const conf = document.getElementById('conf').value;
            const iou = document.getElementById('iou').value;
            const line_width = document.getElementById('line_width').value;

            fetch('/update_params', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    conf: conf,
                    iou: iou,
                    line_width: line_width
                }),
            }).then(response => response.json())
              .then(data => {
                  if (data.status === "success") {
                      alert('Parameters updated successfully!');
                      
                      const player = videojs('myVideo');
                      player.src({
                          src: '/hls/stream.m3u8',
                          type: 'application/x-mpegURL'
                      });
                      player.load();
                      player.play();
                  } else {
                      alert('Failed to update parameters.');
                  }
              });
        }

        // 启动 RTSP 流
        function startStream() {
            const rtspUrl = document.getElementById('rtsp_url').value;
            fetch('/start_stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ rtsp_url: rtspUrl }),
            }).then(response => {
                if (response.ok) {
                    alert('Stream started successfully!');
                } else {
                    alert('Failed to start stream.');
                }
            });
        }

        // 停止 RTSP 流
        function stopStream() {
            fetch('/stop_stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            }).then(response => {
                if (response.ok) {
                    alert('Stream stopped successfully!');
                } else {
                    alert('Failed to stop stream.');
                }
            });
        }

        // Load available models when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadModels();
        });
        
        // Load available models
        function loadModels() {
            fetch('/get_models')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('model_select');
                    select.innerHTML = '';
                    
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        if (model === data.current_model) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                });
        }
        
        // Change detection model
        function changeModel() {
            const modelName = document.getElementById('model_select').value;
            
            fetch('/change_model', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ model_name: modelName }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    alert(data.message);
                    
                    // Reload the video
                    const player = videojs('myVideo');
                    player.src({
                        src: '/hls/stream.m3u8',
                        type: 'application/x-mpegURL'
                    });
                    player.load();
                    player.play();
                } else {
                    alert('Error: ' + data.message);
                }
            });
        }
    </script>
</body>
</html>